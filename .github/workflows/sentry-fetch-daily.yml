name: Sentry fetch daily

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  fetch-daily:
    runs-on: ubuntu-latest
    env:
      SENTRY_TOKEN: ${{ secrets.SENTRY_TOKEN }}
      DROPBOX_APP_KEY: ${{ secrets.DROPBOX_APP_KEY || vars.DROPBOX_APP_KEY }}
      DROPBOX_APP_SECRET: ${{ secrets.DROPBOX_APP_SECRET || vars.DROPBOX_APP_SECRET }}
      DROPBOX_REFRESH_TOKEN: ${{ secrets.DROPBOX_REFRESH_TOKEN || vars.DROPBOX_REFRESH_TOKEN }}
      DROPBOX_UPLOAD_RETRIES: ${{ vars.DROPBOX_UPLOAD_RETRIES }}
      DROPBOX_UPLOAD_RETRY_DELAY: ${{ vars.DROPBOX_UPLOAD_RETRY_DELAY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install dropbox

      - name: Fetch previous day and write parquet output
        run: |
          START_TIME=$(date -u -d "yesterday 00:00:00" +%Y-%m-%dT%H:%M:%S)
          END_TIME=$(date -u -d "today 00:00:00" +%Y-%m-%dT%H:%M:%S)
          mkdir -p output
          for EVENT in started success failed; do
            python src/run.py get \
              --event "${EVENT}" \
              --start-date "${START_TIME}" \
              --end-date "${END_TIME}" \
              --store parquet \
              --output-file "output/$(date -u -d "yesterday 00:00" '+%Y-%m-%d')-${EVENT}.parquet"
          done

      - name: Upload parquet artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fmriprep-stats-${{ github.run_id }}
          path: "output/*.parquet"

      - name: Upload parquet files to Dropbox
        shell: bash
        run: |
          if [[ -z "${DROPBOX_APP_KEY}" || -z "${DROPBOX_APP_SECRET}" || -z "${DROPBOX_REFRESH_TOKEN}" ]]; then
            MISSING=()
            if [[ -z "${DROPBOX_APP_KEY}" ]]; then MISSING+=("DROPBOX_APP_KEY"); fi
            if [[ -z "${DROPBOX_APP_SECRET}" ]]; then MISSING+=("DROPBOX_APP_SECRET"); fi
            if [[ -z "${DROPBOX_REFRESH_TOKEN}" ]]; then MISSING+=("DROPBOX_REFRESH_TOKEN"); fi
            echo "Dropbox credentials missing (${MISSING[*]}); skipping Dropbox upload." >&2
            exit 0
          fi

          python - <<'PY'
          import os
          import time
          from pathlib import Path

          import dropbox
          from dropbox import exceptions, files

          app_key = os.environ["DROPBOX_APP_KEY"]
          app_secret = os.environ["DROPBOX_APP_SECRET"]
          refresh_token = os.environ["DROPBOX_REFRESH_TOKEN"]
          retries = int(os.getenv("DROPBOX_UPLOAD_RETRIES", "3"))
          retry_delay = int(os.getenv("DROPBOX_UPLOAD_RETRY_DELAY", "2"))

          output_dir = Path("output")
          files_to_upload = sorted(output_dir.glob("*.parquet"))
          if not files_to_upload:
              raise SystemExit("No parquet files found to upload.")

          client = dropbox.Dropbox(
              oauth2_refresh_token=refresh_token,
              app_key=app_key,
              app_secret=app_secret,
          )

          failed = False
          for file_path in files_to_upload:
              dropbox_path = f"/{file_path.name}"
              success = False
              for attempt in range(1, retries + 1):
                  try:
                      with file_path.open("rb") as handle:
                          client.files_upload(
                              handle.read(),
                              dropbox_path,
                              mode=files.WriteMode.overwrite,
                          )
                      print(f"[Dropbox] Uploaded {file_path} -> {dropbox_path}.")
                      success = True
                      break
                  except exceptions.ApiError as exc:
                      print(
                          f"[Dropbox] Upload attempt {attempt}/{retries} failed for {file_path}: {exc}",
                          flush=True,
                      )
                  except Exception as exc:
                      print(
                          f"[Dropbox] Upload attempt {attempt}/{retries} failed for {file_path}: {exc}",
                          flush=True,
                      )
                  if attempt < retries:
                      time.sleep(retry_delay * attempt)
              if not success:
                  print(f"[Dropbox] Failed to upload {file_path} after {retries} attempts.")
                  failed = True

          if failed:
              raise SystemExit(1)
          PY
